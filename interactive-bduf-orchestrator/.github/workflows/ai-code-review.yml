name: ðŸ¤– AI-Enhanced Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'tests/**'
      - '*.ts'
      - '*.js'

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI Models extension
        run: |
          gh extension install github/gh-models || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        id: pr-diff
        run: |
          # Get the diff for this PR
          gh pr diff ${{ github.event.number }} > pr-diff.txt
          
          # Get list of changed files
          gh pr diff ${{ github.event.number }} --name-only > changed-files.txt
          
          # Truncate diff if too large (model context limits)
          if [ $(wc -c < pr-diff.txt) -gt 50000 ]; then
            echo "Diff too large, truncating..."
            head -c 50000 pr-diff.txt > pr-diff-truncated.txt
            mv pr-diff-truncated.txt pr-diff.txt
            echo "âš ï¸ **Note**: Diff was truncated due to size limits." >> pr-diff.txt
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Security Review
        id: security-review
        continue-on-error: true
        run: |
          echo "## ðŸ”’ Security Review" > security-review.md
          echo "" >> security-review.md
          
          gh models run --file .github/prompts/code-review/security-review.prompt.yml \
            --variable code_diff="$(cat pr-diff.txt)" \
            --variable file_context="$(cat changed-files.txt)" >> security-review.md 2>/dev/null || {
            echo "âŒ Security review failed or no issues found" >> security-review.md
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Architecture Compliance Review
        id: architecture-review
        continue-on-error: true
        run: |
          echo "## ðŸ—ï¸ Architecture Compliance Review" > architecture-review.md
          echo "" >> architecture-review.md
          
          # Get relevant architecture docs
          ARCH_CONTEXT=""
          if [ -f "ai-docs/technical-architecture/01-system-overview.md" ]; then
            ARCH_CONTEXT=$(head -c 10000 ai-docs/technical-architecture/01-system-overview.md)
          fi
          
          gh models run --file .github/prompts/code-review/architecture-compliance.prompt.yml \
            --variable code_diff="$(cat pr-diff.txt)" \
            --variable changed_files="$(cat changed-files.txt)" \
            --variable architecture_context="$ARCH_CONTEXT" >> architecture-review.md 2>/dev/null || {
            echo "âŒ Architecture review failed" >> architecture-review.md
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Performance Review
        id: performance-review
        continue-on-error: true
        run: |
          echo "## âš¡ Performance Review" > performance-review.md
          echo "" >> performance-review.md
          
          gh models run --file .github/prompts/code-review/performance-review.prompt.yml \
            --variable code_diff="$(cat pr-diff.txt)" \
            --variable performance_context="API Response: <500ms, Real-time: <100ms, Concurrent Users: 1000+" >> performance-review.md 2>/dev/null || {
            echo "âŒ Performance review failed" >> performance-review.md
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Combine Reviews and Post Comment
        run: |
          echo "# ðŸ¤– AI Code Review Summary" > final-review.md
          echo "" >> final-review.md
          echo "*Automated analysis of this pull request using GitHub Models*" >> final-review.md
          echo "" >> final-review.md
          
          # Add each review section
          cat security-review.md >> final-review.md
          echo "" >> final-review.md
          cat architecture-review.md >> final-review.md
          echo "" >> final-review.md
          cat performance-review.md >> final-review.md
          echo "" >> final-review.md
          
          echo "---" >> final-review.md
          echo "*Generated by GitHub Models â€¢ [View Configuration](.github/prompts/)*" >> final-review.md
          
          # Post the combined review as a comment
          gh pr comment ${{ github.event.number }} --body-file final-review.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Review Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-results
          path: |
            final-review.md
            security-review.md
            architecture-review.md
            performance-review.md
            pr-diff.txt
          retention-days: 30